<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Releases</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        body {
            background-color: #1a1a1a;
            color: #f8f8f2;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: #1a1a1a;
            padding: 10px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            z-index: 1000;
        }
        .header-button {
            background-color: #bd93f9;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .header-button:hover {
            background-color: #ff79c6;
        }
        .container {
            margin-top: 60px; /* Platz für den festen Header */
            padding: 20px;
        }
        .release {
            border: 1px solid #bd93f9;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #2b2b2b;
        }
        .release.public {
            border: 1px solid #bd93f9; /* Umrandung für öffentliche Releases */
        }
        .release.not-public {
            border: 1px solid gray; /* Umrandung für nicht öffentliche Releases */
        }
        .release h3 {
            color: #bd93f9;
            cursor: pointer;
        }
        .release p {
            margin: 5px 0;
        }
        .admin-buttons {
            display: flex;
            justify-content: space-between;
        }
        .admin-buttons button {
            background-color: #bd93f9;
            color: #1a1a1a;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .admin-buttons button:hover {
            background-color: #ff79c6;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            width: 80%;
            max-width: 800px;
            overflow-y: auto; /* Scrollen im Popup erlauben */
            max-height: 80vh; /* Maximale Höhe für das Popup */
        }
        .popup-content {
            display: flex;
            flex-direction: column;
        }
        .popup-content label {
            margin-top: 10px;
        }
        .popup-content input,
        .popup-content textarea {
            margin-top: 5px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #bd93f9;
            background-color: #2b2b2b;
            color: #f8f8f2;
        }
        .popup-content button {
            margin-top: 20px;
            background-color: #bd93f9;
            color: #1a1a1a;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .popup-content button:hover {
            background-color: #ff79c6;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            color: #ff79c6;
            font-size: 20px;
        }
        .share-button {
            background-color: #bd93f9;
            color: #1a1a1a;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
        }
        .share-button:hover {
            background-color: #ff79c6;
        }
    </style>
</head>
<body oncontextmenu="return false";>
    <header>
        <button class="header-button" onclick="location.href='/'">Home</button>
    </header>
    <div class="container">
        <h1>Releases</h1>
        <div id="releases-list"></div>
        <div id="admin-controls" style="display: none;">
            <button id="create-release-btn" class="header-button">Create New Release</button>
        </div>
    </div>

    <!-- Popup Form for Creating and Editing Releases -->
    <div id="popup" class="popup">
        <div class="popup-content">
            <span class="close-btn" id="closeBtn">&times;</span>
            <h2 id="popup-title">Add new Release</h2>
            <form id="releaseForm">
                <input type="hidden" id="releaseId" name="releaseId">
                <label for="title">Title:</label>
                <input type="text" id="title" name="title" required>
                
                <label for="channel">Channel:</label>
                <input type="text" id="channel" name="channel" required>
                
                <label for="public">Public:</label>
                <input type="checkbox" id="public" name="public">
                
                <label for="features">Features:</label>
                <textarea id="features" name="features" required></textarea>
                
                <label for="bugFixes">Bug fixes:</label>
                <textarea id="bugFixes" name="bugFixes" required></textarea>
                
                <label for="knownIssues">Known issues:</label>
                <textarea id="knownIssues" name="knownIssues" required></textarea>
                
                <button type="button" id="saveReleaseBtn">Save</button>
            </form>
        </div>
    </div>

    <script>
        let isAdmin = false;
        let currentReleaseId = null;

        async function fetchReleases(query = '') {
            try {
                const response = await fetch(`/api/releases${query ? `?search=${query}` : ''}`);
                const data = await response.json();
                if (data.success) {
                    displayReleases(data.releases);
                } else {
                    console.error('Error fetching releases:', data.message);
                }
            } catch (error) {
                console.error('Error fetching releases:', error);
            }
        }

        function displayReleases(releases) {
            const releasesList = document.getElementById('releases-list');
            releasesList.innerHTML = '';
            releases.forEach(release => {
                const releaseElement = document.createElement('div');
                releaseElement.className = 'release ' + (release.public ? 'public' : 'not-public');
                releaseElement.innerHTML = 
                    `<h3 onclick="redirectToRelease('${release._id}')">${release.title}</h3>
                    <p><strong>Channel:</strong> ${release.channel}</p>`;
                if (isAdmin) {
                    const adminButtons = document.createElement('div');
                    adminButtons.className = 'admin-buttons';
                    adminButtons.innerHTML = 
                        `<button class="share-button" onclick="shareRelease('${release._id}')">Share</button>
                        <button onclick="editRelease('${release._id}')">Edit</button>
                        <button onclick="deleteRelease('${release._id}')">Delete</button>`;
                    releaseElement.appendChild(adminButtons);
                }
                releasesList.appendChild(releaseElement);
            });
        }

        function redirectToRelease(id) {
            window.location.href = `/releases/${id}`;
        }

        async function checkSession() {
            try {
                const response = await fetch('/api/session');
                const data = await response.json();
                if (data.loggedIn) {
                    if (data.isTeam) {
                        document.getElementById('admin-controls').style.display = 'block';
                        isAdmin = true;
                    }
                    fetchReleases();
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Error checking session:', error);
            }
        }

        function openPopup(title) {
            document.getElementById('popup-title').textContent = title;
            document.getElementById('releaseForm').reset();
            document.getElementById('releaseId').value = ''; // Reset the release ID
            document.getElementById('popup').style.display = 'block';
        }

        function closePopup() {
            document.getElementById('popup').style.display = 'none';
        }

        async function saveRelease() {
            const id = document.getElementById('releaseId').value;
            const title = document.getElementById('title').value;
            const channel = document.getElementById('channel').value;
            const publicRelease = document.getElementById('public').checked;
            const features = document.getElementById('features').value;
            const bugFixes = document.getElementById('bugFixes').value;
            const knownIssues = document.getElementById('knownIssues').value;

            const releaseData = { title, channel, public: publicRelease, features, bugFixes, knownIssues };

            try {
                const response = await fetch(`/api/releases${id ? `/${id}` : ''}`, {
                    method: id ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(releaseData),
                });
                const data = await response.json();
                if (data.success) {
                    fetchReleases();
                    closePopup();
                } else {
                    console.error('Error saving release:', data.message);
                }
            } catch (error) {
                console.error('Error saving release:', error);
            }
        }

        function editRelease(id) {
            fetch(`/api/releases/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const release = data.release;
                        document.getElementById('releaseId').value = release._id;
                        document.getElementById('title').value = release.title;
                        document.getElementById('channel').value = release.channel;
                        document.getElementById('public').checked = release.public;
                        document.getElementById('features').value = release.features;
                        document.getElementById('bugFixes').value = release.bugFixes;
                        document.getElementById('knownIssues').value = release.knownIssues;
                        openPopup('Edit Release');
                    } else {
                        console.error('Error fetching release:', data.message);
                    }
                })
                .catch(error => console.error('Error fetching release:', error));
        }

        async function deleteRelease(id) {
            if (confirm('Are you sure you want to delete this release?')) {
                try {
                    const response = await fetch(`/api/releases/${id}`, {
                        method: 'DELETE',
                    });
                    const data = await response.json();
                    if (data.success) {
                        fetchReleases();
                    } else {
                        console.error('Error deleting release:', data.message);
                    }
                } catch (error) {
                    console.error('Error deleting release:', error);
                }
            }
        }

        function shareRelease(id) {
            const releaseUrl = `${window.location.origin}/releases/${id}`;
            navigator.clipboard.writeText(releaseUrl)
                .then(() => alert('Release link copied to clipboard'))
                .catch(err => console.error('Error copying text: ', err));
        }

        document.getElementById('create-release-btn').addEventListener('click', () => openPopup('Add New Release'));
        document.getElementById('closeBtn').addEventListener('click', closePopup);
        document.getElementById('saveReleaseBtn').addEventListener('click', saveRelease);

        checkSession();
    </script>
    
</body>
</html>
